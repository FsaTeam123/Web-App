<section class="session-root">
  <!-- Header da sess√£o (substitui o header fixo nessa p√°gina) -->
  <header class="session-header" #hdr>
    <div class="session-info" *ngIf="jogo as game">
        <span class="badge">#{{ game.idJogo || game.id }}</span>
        <strong class="title">{{ game.titulo || 'Sess√£o' }}</strong>
    </div>

    <nav class="session-nav" aria-label="Navega√ß√£o da sess√£o">
        <!-- HOME -->
        <button class="nav-btn" [class.active]="activeTab==='home'" (click)="go('home')" title="Home">
            <!-- casinha -->
            <svg viewBox="0 0 24 24" class="ico">
            <path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z"/>
            </svg>
            <span class="nav-label">Home</span>
        </button>

        <!-- (antigo Lobby) agora MESA -->
        <button class="nav-btn" (click)="openMesa()" title="Mesa (Participantes)">
            <svg viewBox="0 0 24 24" class="ico">
                <path d="M3 6h18v3H3V6zm0 5h18v3H3v-3zm0 5h18v3H3v-3z"/>
            </svg>
            <span class="nav-label">Mesa</span>
        </button>

        <button class="nav-btn" [class.active]="activeTab==='personagens'" (click)="go('personagens')" title="Personagens">
            <svg viewBox="0 0 24 24" class="ico"><path d="M16 11a4 4 0 1 0-3.999-4A4 4 0 0 0 16 11zM8 13a4 4 0 1 0-3.999-4A4 4 0 0 0 8 13zm8 2c-3.314 0-6 2.014-6 4.5V22h12v-2.5c0-2.486-2.686-4.5-6-4.5zm-8 0C4.686 15 2 17.014 2 19.5V22h8v-2.5C10 17.014 7.314 15 4 15z"/></svg>
            <span class="nav-label">Personagens</span>
        </button>

        <button class="nav-btn" [class.active]="activeTab==='mapas'" (click)="go('mapas')" title="Mapas">
            <svg viewBox="0 0 24 24" class="ico"><path d="M15 6l-6 2-5-2v14l6 2 6-2 5 2V8l-6-2zm0 2.2l4 1.6v10l-4-1.6V8.2zM9 8.2l6-2.2v10.8l-6 2.2V8.2zM4 7.2l4 1.6v10.8l-4-1.6V7.2z"/></svg>
            <span class="nav-label">Mapas</span>
        </button>

        <button class="nav-btn" [class.active]="activeTab==='anotacoes'" (click)="go('anotacoes')" title="Anota√ß√µes">
            <svg viewBox="0 0 24 24" class="ico"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5"/></svg>
            <span class="nav-label">Anota√ß√µes</span>
        </button>

        <button class="nav-btn" [class.active]="activeTab==='chat'" (click)="go('chat')" title="Chat">
            <svg viewBox="0 0 24 24" class="ico"><path d="M21 6a3 3 0 0 0-3-3H6a3 3 0 0 0-3 3v9a3 3 0 0 0 3 3h6l5 4v-4h1a3 3 0 0 0 3-3V6z"/></svg>
            <span class="nav-label">Chat</span>
        </button>
    </nav>
  </header>

  <!-- Canvas + UI -->
  <div class="canvas-wrap">
    <canvas #gridCanvas class="grid-canvas"></canvas>

    <!-- Zoom -->
    <div class="zoom-panel">
      <button class="zbtn" (click)="zoomOut()" aria-label="Diminuir zoom">‚àí</button>
      <input type="range" min="20" max="400" [(ngModel)]="zoomPercent" />
      <button class="zbtn" (click)="zoomIn()" aria-label="Aumentar zoom">+</button>
      <span class="zread">{{ zoomPercent }}%</span>
      <button class="zreset" (click)="zoomReset()">Reset</button>
    </div>

    <!-- Ferramentas de desenho -->
    <div class="draw-panel">
      <div class="row">
        <button class="tbtn" [class.active]="tool==='pencil'"  (click)="tool='pencil'">‚úèÔ∏è</button>
        <button class="tbtn" [class.active]="tool==='eraser'"  (click)="tool='eraser'">ü©π</button>
        <button class="tbtn" [class.active]="tool==='rect'"    (click)="tool='rect'">‚ñ≠</button>
        <button class="tbtn" [class.active]="tool==='ellipse'" (click)="tool='ellipse'">‚óØ</button>
      </div>
      <div class="row">
        <input type="color" [(ngModel)]="color" [disabled]="tool==='eraser'">
      </div>
      <div class="row">
        <label class="mini">Px</label>
        <input type="range" min="1" max="32" [(ngModel)]="stroke">
        <span class="mini">{{ stroke }}</span>
      </div>
      <div class="row">
        <button class="tbtn" (click)="undo()" title="Desfazer">‚Ü∂</button>
        <button class="tbtn" (click)="redo()" title="Refazer">‚Ü∑</button>
        <button class="tbtn danger" (click)="clearArt()" title="Limpar">üóëÔ∏è</button>
      </div>
      <div class="hint">Pan: Ctrl/üñ±Ô∏è meio ‚Ä¢ Zoom: Scroll/Pinch ‚Ä¢ Desenho: bot√£o esquerdo</div>
    </div>
  </div>
</section>

<div class="mesa-overlay" *ngIf="mesaOpen" (click)="closeMesa()">
  <div class="mesa-modal" (click)="$event.stopPropagation()">
    <header class="mesa-header">
      <h3>Mesa ‚Äî Participantes</h3>
      <div class="spacer"></div>
      <button class="mesa-icon" (click)="closeMesa()" aria-label="Fechar">‚úï</button>
    </header>

    <div class="mesa-body">
      <div *ngIf="mesaLoading" class="mesa-muted">Carregando participantes‚Ä¶</div>
      <div *ngIf="mesaErr" class="mesa-err">{{ mesaErr }}</div>

      <!-- Mestre -->
      <div *ngIf="mesaMaster as master" class="master-card">
        <div class="avatar-wrap">
            <img class="avatar"
                [src]="master._hasPhoto ? master.fotoUrl : DEFAULT_AVATAR_PATH"
                (error)="handleImageError(master)"
                alt="Mestre avatar">
            <span class="status-dot" [class.online]="master.online === 1"></span>
        </div>
        <div class="info">
            <div class="line1">
            <strong class="nick">{{ master.nickname }}</strong>
            <span class="id">#{{ master.idUsuario }}</span>
            <span class="role">Mestre</span>
            </div>
        </div>
      </div>

      <hr class="mesa-sep" *ngIf="mesaMaster">

      <!-- Jogadores -->
      <div class="players-grid">
        <div class="player-card" *ngFor="let p of mesaPlayers; trackBy: trackByUserId">
          <div class="avatar-wrap">
            <img class="avatar"
                 [src]="p._hasPhoto ? p.fotoUrl : DEFAULT_AVATAR_PATH"
                 (error)="handleImageError(p)"
                 [attr.alt]="p.nickname">
            <span class="status-dot" [class.online]="p.online === 1"></span>
          </div>
          <div class="info">
            <div class="line1">
              <strong class="nick">{{ p.nickname }}</strong>
              <span class="id">#{{ p.userId }}</span>
            </div>
            <div class="line2">{{ p.playerNome }}</div>
          </div>
        </div>
        <div *ngIf="!mesaLoading && !mesaErr && mesaPlayers?.length===0" class="mesa-muted">
          Nenhum jogador na mesa ainda.
        </div>
      </div>
    </div>
  </div>
</div>
